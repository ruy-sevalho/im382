import numpy as np
import matplotlib.pyplot as plt

from truss2d import TrussInputs
from newton_raphson import ConvergenceCriteria, NewtonRaphsonConvergenceParam
from large_deformation_plasticity import Analysis


coords = np.array(
    [
        [0, 0],
        [2, 0],
        [0, 2],
        [2, 2],
        [0, 4],
        [2, 4],
        [0, 6],
        [2, 6],
        [0, 8],
        [2, 8],
        [0, 10],
        [2, 10],
        [0, 12],
        [2, 12],
        [0, 14],
        [2, 14],
        [0, 16],
        [2, 16],
        [0, 18],
        [2, 18],
        [0, 20],
        [2, 20],
        [0, 22],
        [2, 22],
        [0, 24],
        [2, 24],
        [0, 26],
        [2, 26],
        [0, 28],
        [2, 28],
        [0, 30],
        [2, 30],
        [0, 32],
        [2, 32],
        [0, 34],
        [2, 34],
        [0, 36],
        [2, 36],
        [0, 38],
        [2, 38],
        [0, 40],
        [2, 40],
        [0, 42],
        [2, 42],
        [0, 44],
        [2, 44],
        [0, 46],
        [2, 46],
        [0, 48],
        [2, 48],
        [0, 50],
        [2, 50],
        [0, 52],
        [2, 52],
        [0, 54],
        [2, 54],
        [0, 56],
        [2, 56],
        [0, 58],
        [2, 58],
        [0, 60],
        [2, 60],
        [0, 62],
        [2, 62],
        [0, 64],
        [2, 64],
        [0, 66],
        [2, 66],
        [0, 68],
        [2, 68],
        [0, 70],
        [2, 70],
        [0, 72],
        [2, 72],
        [0, 74],
        [2, 74],
        [0, 76],
        [2, 76],
        [0, 78],
        [2, 78],
        [0, 80],
        [2, 80],
        [0, 82],
        [2, 82],
        [0, 84],
        [2, 84],
        [0, 86],
        [2, 86],
        [0, 88],
        [2, 88],
        [0, 90],
        [2, 90],
        [0, 92],
        [2, 92],
        [0, 94],
        [2, 94],
        [0, 96],
        [2, 96],
        [0, 98],
        [2, 98],
        [0, 100],
        [2, 100],
        [0, 102],
        [2, 102],
        [0, 104],
        [2, 104],
        [0, 106],
        [2, 106],
        [0, 108],
        [2, 108],
        [0, 110],
        [2, 110],
        [0, 112],
        [2, 112],
        [0, 114],
        [2, 114],
        [0, 116],
        [2, 116],
        [0, 118],
        [2, 118],
        [0, 120],
        [2, 120],
        [4, 118],
        [4, 120],
        [6, 118],
        [6, 120],
        [8, 118],
        [8, 120],
        [10, 118],
        [10, 120],
        [12, 118],
        [12, 120],
        [14, 118],
        [14, 120],
        [16, 118],
        [16, 120],
        [18, 118],
        [18, 120],
        [20, 118],
        [20, 120],
        [22, 118],
        [22, 120],
        [24, 118],
        [24, 120],
        [26, 118],
        [26, 120],
        [28, 118],
        [28, 120],
        [30, 118],
        [30, 120],
        [32, 118],
        [32, 120],
        [34, 118],
        [34, 120],
        [36, 118],
        [36, 120],
        [38, 118],
        [38, 120],
        [40, 118],
        [40, 120],
        [42, 118],
        [42, 120],
        [44, 118],
        [44, 120],
        [46, 118],
        [46, 120],
        [48, 118],
        [48, 120],
        [50, 118],
        [50, 120],
        [52, 118],
        [52, 120],
        [54, 118],
        [54, 120],
        [56, 118],
        [56, 120],
        [58, 118],
        [58, 120],
        [60, 118],
        [60, 120],
        [62, 118],
        [62, 120],
        [64, 118],
        [64, 120],
        [66, 118],
        [66, 120],
        [68, 118],
        [68, 120],
        [70, 118],
        [70, 120],
        [72, 118],
        [72, 120],
        [74, 118],
        [74, 120],
        [76, 118],
        [76, 120],
        [78, 118],
        [78, 120],
        [80, 118],
        [80, 120],
        [82, 118],
        [82, 120],
        [84, 118],
        [84, 120],
        [86, 118],
        [86, 120],
        [88, 118],
        [88, 120],
        [90, 118],
        [90, 120],
        [92, 118],
        [92, 120],
        [94, 118],
        [94, 120],
        [96, 118],
        [96, 120],
        [98, 118],
        [98, 120],
        [100, 118],
        [100, 120],
        [102, 118],
        [102, 120],
        [104, 118],
        [104, 120],
        [106, 118],
        [106, 120],
        [108, 118],
        [108, 120],
        [110, 118],
        [110, 120],
        [112, 118],
        [112, 120],
        [114, 118],
        [114, 120],
        [116, 118],
        [116, 120],
        [118, 118],
        [118, 120],
        [120, 118],
        [120, 120],
    ]
)
incidence = np.array(
    [
        [0, 1],
        [0, 2],
        [1, 3],
        [0, 3],
        [1, 2],
        [2, 3],
        [2, 4],
        [3, 5],
        [2, 5],
        [3, 4],
        [4, 5],
        [4, 6],
        [5, 7],
        [4, 7],
        [5, 6],
        [6, 7],
        [6, 8],
        [7, 9],
        [6, 9],
        [7, 8],
        [8, 9],
        [8, 10],
        [9, 11],
        [8, 11],
        [9, 10],
        [10, 11],
        [10, 12],
        [11, 13],
        [10, 13],
        [11, 12],
        [12, 13],
        [12, 14],
        [13, 15],
        [12, 15],
        [13, 14],
        [14, 15],
        [14, 16],
        [15, 17],
        [14, 17],
        [15, 16],
        [16, 17],
        [16, 18],
        [17, 19],
        [16, 19],
        [17, 18],
        [18, 19],
        [18, 20],
        [19, 21],
        [18, 21],
        [19, 20],
        [20, 21],
        [20, 22],
        [21, 23],
        [20, 23],
        [21, 22],
        [22, 23],
        [22, 24],
        [23, 25],
        [22, 25],
        [23, 24],
        [24, 25],
        [24, 26],
        [25, 27],
        [24, 27],
        [25, 26],
        [26, 27],
        [26, 28],
        [27, 29],
        [26, 29],
        [27, 28],
        [28, 29],
        [28, 30],
        [29, 31],
        [28, 31],
        [29, 30],
        [30, 31],
        [30, 32],
        [31, 33],
        [30, 33],
        [31, 32],
        [32, 33],
        [32, 34],
        [33, 35],
        [32, 35],
        [33, 34],
        [34, 35],
        [34, 36],
        [35, 37],
        [34, 37],
        [35, 36],
        [36, 37],
        [36, 38],
        [37, 39],
        [36, 39],
        [37, 38],
        [38, 39],
        [38, 40],
        [39, 41],
        [38, 41],
        [39, 40],
        [40, 41],
        [40, 42],
        [41, 43],
        [40, 43],
        [41, 42],
        [42, 43],
        [42, 44],
        [43, 45],
        [42, 45],
        [43, 44],
        [44, 45],
        [44, 46],
        [45, 47],
        [44, 47],
        [45, 46],
        [46, 47],
        [46, 48],
        [47, 49],
        [46, 49],
        [47, 48],
        [48, 49],
        [48, 50],
        [49, 51],
        [48, 51],
        [49, 50],
        [50, 51],
        [50, 52],
        [51, 53],
        [50, 53],
        [51, 52],
        [52, 53],
        [52, 54],
        [53, 55],
        [52, 55],
        [53, 54],
        [54, 55],
        [54, 56],
        [55, 57],
        [54, 57],
        [55, 56],
        [56, 57],
        [56, 58],
        [57, 59],
        [56, 59],
        [57, 58],
        [58, 59],
        [58, 60],
        [59, 61],
        [58, 61],
        [59, 60],
        [60, 61],
        [60, 62],
        [61, 63],
        [60, 63],
        [61, 62],
        [62, 63],
        [62, 64],
        [63, 65],
        [62, 65],
        [63, 64],
        [64, 65],
        [64, 66],
        [65, 67],
        [64, 67],
        [65, 66],
        [66, 67],
        [66, 68],
        [67, 69],
        [66, 69],
        [67, 68],
        [68, 69],
        [68, 70],
        [69, 71],
        [68, 71],
        [69, 70],
        [70, 71],
        [70, 72],
        [71, 73],
        [70, 73],
        [71, 72],
        [72, 73],
        [72, 74],
        [73, 75],
        [72, 75],
        [73, 74],
        [74, 75],
        [74, 76],
        [75, 77],
        [74, 77],
        [75, 76],
        [76, 77],
        [76, 78],
        [77, 79],
        [76, 79],
        [77, 78],
        [78, 79],
        [78, 80],
        [79, 81],
        [78, 81],
        [79, 80],
        [80, 81],
        [80, 82],
        [81, 83],
        [80, 83],
        [81, 82],
        [82, 83],
        [82, 84],
        [83, 85],
        [82, 85],
        [83, 84],
        [84, 85],
        [84, 86],
        [85, 87],
        [84, 87],
        [85, 86],
        [86, 87],
        [86, 88],
        [87, 89],
        [86, 89],
        [87, 88],
        [88, 89],
        [88, 90],
        [89, 91],
        [88, 91],
        [89, 90],
        [90, 91],
        [90, 92],
        [91, 93],
        [90, 93],
        [91, 92],
        [92, 93],
        [92, 94],
        [93, 95],
        [92, 95],
        [93, 94],
        [94, 95],
        [94, 96],
        [95, 97],
        [94, 97],
        [95, 96],
        [96, 97],
        [96, 98],
        [97, 99],
        [96, 99],
        [97, 98],
        [98, 99],
        [98, 100],
        [99, 101],
        [98, 101],
        [99, 100],
        [100, 101],
        [100, 102],
        [101, 103],
        [100, 103],
        [101, 102],
        [102, 103],
        [102, 104],
        [103, 105],
        [102, 105],
        [103, 104],
        [104, 105],
        [104, 106],
        [105, 107],
        [104, 107],
        [105, 106],
        [106, 107],
        [106, 108],
        [107, 109],
        [106, 109],
        [107, 108],
        [108, 109],
        [108, 110],
        [109, 111],
        [108, 111],
        [109, 110],
        [110, 111],
        [110, 112],
        [111, 113],
        [110, 113],
        [111, 112],
        [112, 113],
        [112, 114],
        [113, 115],
        [112, 115],
        [113, 114],
        [114, 115],
        [114, 116],
        [115, 117],
        [114, 117],
        [115, 116],
        [116, 117],
        [116, 118],
        [117, 119],
        [116, 119],
        [117, 118],
        [118, 119],
        [118, 120],
        [119, 121],
        [118, 121],
        [119, 120],
        [120, 121],
        [119, 122],
        [121, 123],
        [119, 123],
        [121, 122],
        [122, 123],
        [122, 124],
        [123, 125],
        [122, 125],
        [123, 124],
        [124, 125],
        [124, 126],
        [125, 127],
        [124, 127],
        [125, 126],
        [126, 127],
        [126, 128],
        [127, 129],
        [126, 129],
        [127, 128],
        [128, 129],
        [128, 130],
        [129, 131],
        [128, 131],
        [129, 130],
        [130, 131],
        [130, 132],
        [131, 133],
        [130, 133],
        [131, 132],
        [132, 133],
        [132, 134],
        [133, 135],
        [132, 135],
        [133, 134],
        [134, 135],
        [134, 136],
        [135, 137],
        [134, 137],
        [135, 136],
        [136, 137],
        [136, 138],
        [137, 139],
        [136, 139],
        [137, 138],
        [138, 139],
        [138, 140],
        [139, 141],
        [138, 141],
        [139, 140],
        [140, 141],
        [140, 142],
        [141, 143],
        [140, 143],
        [141, 142],
        [142, 143],
        [142, 144],
        [143, 145],
        [142, 145],
        [143, 144],
        [144, 145],
        [144, 146],
        [145, 147],
        [144, 147],
        [145, 146],
        [146, 147],
        [146, 148],
        [147, 149],
        [146, 149],
        [147, 148],
        [148, 149],
        [148, 150],
        [149, 151],
        [148, 151],
        [149, 150],
        [150, 151],
        [150, 152],
        [151, 153],
        [150, 153],
        [151, 152],
        [152, 153],
        [152, 154],
        [153, 155],
        [152, 155],
        [153, 154],
        [154, 155],
        [154, 156],
        [155, 157],
        [154, 157],
        [155, 156],
        [156, 157],
        [156, 158],
        [157, 159],
        [156, 159],
        [157, 158],
        [158, 159],
        [158, 160],
        [159, 161],
        [158, 161],
        [159, 160],
        [160, 161],
        [160, 162],
        [161, 163],
        [160, 163],
        [161, 162],
        [162, 163],
        [162, 164],
        [163, 165],
        [162, 165],
        [163, 164],
        [164, 165],
        [164, 166],
        [165, 167],
        [164, 167],
        [165, 166],
        [166, 167],
        [166, 168],
        [167, 169],
        [166, 169],
        [167, 168],
        [168, 169],
        [168, 170],
        [169, 171],
        [168, 171],
        [169, 170],
        [170, 171],
        [170, 172],
        [171, 173],
        [170, 173],
        [171, 172],
        [172, 173],
        [172, 174],
        [173, 175],
        [172, 175],
        [173, 174],
        [174, 175],
        [174, 176],
        [175, 177],
        [174, 177],
        [175, 176],
        [176, 177],
        [176, 178],
        [177, 179],
        [176, 179],
        [177, 178],
        [178, 179],
        [178, 180],
        [179, 181],
        [178, 181],
        [179, 180],
        [180, 181],
        [180, 182],
        [181, 183],
        [180, 183],
        [181, 182],
        [182, 183],
        [182, 184],
        [183, 185],
        [182, 185],
        [183, 184],
        [184, 185],
        [184, 186],
        [185, 187],
        [184, 187],
        [185, 186],
        [186, 187],
        [186, 188],
        [187, 189],
        [186, 189],
        [187, 188],
        [188, 189],
        [188, 190],
        [189, 191],
        [188, 191],
        [189, 190],
        [190, 191],
        [190, 192],
        [191, 193],
        [190, 193],
        [191, 192],
        [192, 193],
        [192, 194],
        [193, 195],
        [192, 195],
        [193, 194],
        [194, 195],
        [194, 196],
        [195, 197],
        [194, 197],
        [195, 196],
        [196, 197],
        [196, 198],
        [197, 199],
        [196, 199],
        [197, 198],
        [198, 199],
        [198, 200],
        [199, 201],
        [198, 201],
        [199, 200],
        [200, 201],
        [200, 202],
        [201, 203],
        [200, 203],
        [201, 202],
        [202, 203],
        [202, 204],
        [203, 205],
        [202, 205],
        [203, 204],
        [204, 205],
        [204, 206],
        [205, 207],
        [204, 207],
        [205, 206],
        [206, 207],
        [206, 208],
        [207, 209],
        [206, 209],
        [207, 208],
        [208, 209],
        [208, 210],
        [209, 211],
        [208, 211],
        [209, 210],
        [210, 211],
        [210, 212],
        [211, 213],
        [210, 213],
        [211, 212],
        [212, 213],
        [212, 214],
        [213, 215],
        [212, 215],
        [213, 214],
        [214, 215],
        [214, 216],
        [215, 217],
        [214, 217],
        [215, 216],
        [216, 217],
        [216, 218],
        [217, 219],
        [216, 219],
        [217, 218],
        [218, 219],
        [218, 220],
        [219, 221],
        [218, 221],
        [219, 220],
        [220, 221],
        [220, 222],
        [221, 223],
        [220, 223],
        [221, 222],
        [222, 223],
        [222, 224],
        [223, 225],
        [222, 225],
        [223, 224],
        [224, 225],
        [224, 226],
        [225, 227],
        [224, 227],
        [225, 226],
        [226, 227],
        [226, 228],
        [227, 229],
        [226, 229],
        [227, 228],
        [228, 229],
        [228, 230],
        [229, 231],
        [228, 231],
        [229, 230],
        [230, 231],
        [230, 232],
        [231, 233],
        [230, 233],
        [231, 232],
        [232, 233],
        [232, 234],
        [233, 235],
        [232, 235],
        [233, 234],
        [234, 235],
        [234, 236],
        [235, 237],
        [234, 237],
        [235, 236],
        [236, 237],
        [236, 238],
        [237, 239],
        [236, 239],
        [237, 238],
        [238, 239],
    ]
)
boundary_conditions = np.array([[1, 0], [1, 1], [238, 0], [238, 1]])
loads = np.array([[143, 1, -100]])  # N
truss = TrussInputs(
    coords=coords,
    incidences=incidence,
    boundary_conditions=boundary_conditions,
    loads=loads,
    young_modulus=210000,  # N / mm2
    isotropic_hardening=1800,  # kN / mm2
    yield_stress=2500,  # N / mm2
    section_area=1,  # mm2
)
convergence_criteria = NewtonRaphsonConvergenceParam(
    n_load_steps=1000,
    max_iterations=100,
    precision=1e-5,
    convergence_criteria=ConvergenceCriteria.DISPLACEMENT,
)


analysis = Analysis(truss=truss, convergence_crit=convergence_criteria)
res = analysis.results

ax: plt.Axes
fig, ax = plt.subplots()
fig.set_dpi(600)
x, y = coords[:, 0], coords[:, 1]
# [plt.text(i, j, f"{n}", size=2) for n, (i, j) in enumerate(zip(x, y))]
deformed_coords = analysis.deformed_shape()
for e in incidence:
    ax.plot(
        coords[e][:, 0],
        coords[e][:, 1],
        linewidth=0.2,
        color="blue",
        linestyle="dashed",
    )
    ax.plot(
        deformed_coords[e][:, 0], deformed_coords[e][:, 1], linewidth=0.2, color="red"
    )
